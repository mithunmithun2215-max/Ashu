const axios = require("axios");
const fs = require("fs-extra");
const path = require("path");

// ================= CREATOR LOCK =================
const CREATOR_LOCK = (() => {
  const encoded = "QVJJRiBCQUJV";
  return Buffer.from(encoded, "base64").toString("utf8");
})();

module.exports.config = {
  name: "group",
  version: "1.0.1",
  hasPermssion: 1, // only admin
  credits: "ARIF BABU",
  description: "Group management (name, emoji, image, admin add)",
  commandCategory: "Group",
  usages: "group",
  cooldowns: 5
};

// ğŸ” Credit Check
if (module.exports.config.credits !== CREATOR_LOCK) {
  console.log("âŒ Creator Lock Activated! Credits cannot be changed.");
  module.exports.run = () => {};
  return;
}

module.exports.run = async function ({ api, event, args }) {
  const { threadID, messageID } = event;

  // ğŸ”¹ Help menu
  if (!args || args.length === 0) {
    const helpMessage =
      `ğŸ“‹ Group Management Commands\n\n` +
      `1ï¸âƒ£ group name <new name>\n` +
      `â€¢ Change group name\n` +
      `â€¢ Example: group name My Group\n\n` +
      `2ï¸âƒ£ group emoji <emoji>\n` +
      `â€¢ Change group emoji\n` +
      `â€¢ Example: group emoji ğŸ”¥\n\n` +
      `3ï¸âƒ£ group image\n` +
      `â€¢ Change group photo (reply to image)\n\n` +
      `4ï¸âƒ£ group adminadd @mention\n` +
      `â€¢ Make user admin\n\n` +
      `âš ï¸ Bot & user must be group admin`;

    return api.sendMessage(helpMessage, threadID, messageID);
  }

  const sub = args[0].toLowerCase();

  try {
    switch (sub) {
      case "name":
        return handleGroupName(api, event, args.slice(1));

      case "emoji":
        return handleGroupEmoji(api, event, args.slice(1));

      case "image":
      case "photo":
      case "pic":
        return handleGroupImage(api, event);

      case "adminadd":
      case "addadmin":
        return handleAdminAdd(api, event);

      default:
        return api.sendMessage(
          `âŒ Unknown option: ${sub}\nUse: group`,
          threadID,
          messageID
        );
    }
  } catch (e) {
    console.log(e);
    return api.sendMessage(
      "âŒ Error while executing group command",
      threadID,
      messageID
    );
  }
};

/* ================= FUNCTIONS ================= */

async function handleGroupName(api, event, args) {
  const { threadID, messageID } = event;

  if (!args.length)
    return api.sendMessage(
      "âŒ Group name likho\nExample: group name New Group",
      threadID,
      messageID
    );

  const name = args.join(" ");

  await api.setTitle(name, threadID);
  return api.sendMessage(
    `âœ… Group name changed\nğŸ“ ${name}`,
    threadID
  );
}

async function handleGroupEmoji(api, event, args) {
  const { threadID, messageID } = event;

  if (!args.length)
    return api.sendMessage(
      "âŒ Emoji do\nExample: group emoji ğŸ˜",
      threadID,
      messageID
    );

  await api.changeThreadEmoji(args[0], threadID);
  return api.sendMessage(
    `âœ… Group emoji changed ${args[0]}`,
    threadID
  );
}

async function handleGroupImage(api, event) {
  const { threadID, messageID, messageReply } = event;

  if (!messageReply || !messageReply.attachments.length)
    return api.sendMessage(
      "âŒ Image pe reply karo",
      threadID,
      messageID
    );

  const img = messageReply.attachments.find(a => a.type === "photo");
  if (!img)
    return api.sendMessage("âŒ Photo nahi mila", threadID, messageID);

  const tempPath = path.join(__dirname, "cache");
  if (!fs.existsSync(tempPath)) fs.mkdirSync(tempPath);

  const filePath = path.join(tempPath, `group_${Date.now()}.jpg`);
  const res = await axios.get(img.url, { responseType: "arraybuffer" });
  fs.writeFileSync(filePath, res.data);

  await api.changeGroupImage(fs.createReadStream(filePath), threadID);
  fs.unlinkSync(filePath);

  return api.sendMessage("âœ… Group image updated ğŸ“¸", threadID);
}

async function handleAdminAdd(api, event) {
  const { threadID, messageID, mentions } = event;

  if (!mentions || !Object.keys(mentions).length)
    return api.sendMessage(
      "âŒ Kisi user ko mention karo",
      threadID,
      messageID
    );

  const uid = Object.keys(mentions)[0];
  await api.changeAdminStatus(threadID, uid, true);

  return api.sendMessage(
    `âœ… Admin bana diya ${mentions[uid]}`,
    threadID
  );
}